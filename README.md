<h1 id="top" align="center">WEB API</h1>

### Configure Env Variables

-   Rename `.env.dev.code.example` or `.env.dev.docker.example` as `.env.dev` with proper configuration. (If you launch from docker copy .docker.example, if you launch from development environment VS Code etc..., copy .code.example)

-   Rename `.env.prod.example` as `.env.prod` with proper configuration.

<br/>

### Development Mode

-   Install dependencies

```
npm i
```

-   Run dev server with hot reload

```
npm run dev
```

<br/>

### Production mode

-   Refer system startup commands for production launch. Check [`docker-config`](https://github.com/staucktion/docker-config) repository.

<br/>

### API Authentication

Many endpoints in the API require authentication. Authentication is implemented using JSON Web Tokens (JWT).

-   Authenticated endpoints require a valid JWT token provided in a cookie named `token`
-   The following endpoints require authentication:
    -   POST `/mail/send` - Sending emails
    -   POST `/locations` - Creating locations
    -   PUT `/locations/:id` - Updating locations
    -   DELETE `/locations/:id` - Deleting locations
    -   POST `/categories` - Creating categories
    -   PUT `/categories/:id` - Updating categories
    -   DELETE `/categories/:id` - Deleting categories

#### How to Get Your Authentication Token

To obtain your authentication token from an existing authenticated session:

1. Log in to the application in your browser
2. Open Developer Tools (F12 or Right Click â†’ Inspect)
3. Navigate to the "Application" tab
4. Select "Cookies" in the left sidebar
5. Find the appropriate domain in the list
6. Look for a cookie named "token"
7. Copy the value of this cookie to use in your API requests

<br/>

### Test endpoint

/test directory includes postman endpoint test. The Postman collection has been updated to indicate which endpoints require authentication.

To use authenticated endpoints in Postman:

1. Set the AUTH_TOKEN variable in the collection with your JWT token (see instructions above on how to get your token)
2. The token will be automatically included in the request header

<br/>

### Updating Prisma

-   Make changes on database.
-   Use git bash as terminal to run following commands (do not use powershell as creating file in different format).

#### All Prisma (It will re-create prisma completely. Generally not needed, following title could be more suitable to update prisma)

```
rm -r ./prisma
npx prisma init
npx prisma db pull
```

#### Change Migration (It will update prisma.schema and re-create migration which satisfy changes)

```
rm ./prisma/migrations/0_init/migration.sql
npx prisma db pull
mkdir -p ./prisma/migrations/0_init
npx prisma migrate diff --from-empty --to-schema-datamodel prisma/schema.prisma --script > prisma/migrations/0_init/migration.sql
npx prisma migrate resolve --applied 0_init
npx prisma generate
npm run dev
```

<br/>

### E-Mail System Setup

For email configuration to work, you need to provide the required parameters.

#### Gmail (Easy for Local Testing)

You first need to get the Gmail ["App Password"](https://itsupport.umd.edu/itsupport?id=kb_article_view&sysparm_article=KB0015112) generated by Google. After that, fill in the related .env file (.env.dev or .env.prod) with the following fields:

EMAIL_FROM="your-gmail-here@gmail.com"
EMAIL_USER="your-gmail-here@gmail.com"
EMAIL_PASS="app password you generated here"
EMAIL_SMTP=smtp.gmail.com

#### SendGrid (Production)

For SendGrid, fill in the related .env file (.env.dev or .env.prod) with the following fields:

EMAIL_FROM="noreply@staucktion.com.tr"
EMAIL_USER="apikey"
EMAIL_PASS="your API key that starts with SG."
EMAIL_SMTP=smtp.sendgrid.net

<br/>

## Content Moderation

The application includes content moderation features for photos and categories. All new photos and categories are created with a "WAIT" status and require approval before they are visible to the public.

### Status Flow

1. When a new photo or category is created, it is set to "WAIT" status
2. Administrators can view items in "WAIT" status and either approve or reject them
3. Only "APPROVED" items are visible to the general public in standard API endpoints
4. When an approved item is updated, it returns to "WAIT" status and requires re-approval

<br/>
